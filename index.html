<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Grow A Plant!</title>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>🌱 Grow A Plant!</h1>
        </div>
        <div class="game-area">
            <div class="stats">
                <div class="stat">
                    <span class="stat-label">💧 Water:</span>
                    <div class="stat-bar">
                        <div class="stat-fill water-fill" id="water-bar" style="width: 100%"></div>
                    </div>
                </div>
                <div class="stat">
                    <span class="stat-label">😊 Happy:</span>
                    <div class="stat-bar">
                        <div class="stat-fill happiness-fill" id="happiness-bar" style="width: 80%"></div>
                    </div>
                </div>
                <div class="stat">
                    <span class="stat-label">🌿 Plant:</span>
                    <span id="plant-type">Sunflower</span>
                </div>
            </div>

            <div class="plant-container">
                <div class="pot" id="pot">
                    <div class="plant" id="plant">🌻</div>
                </div>
            </div>

            <div class="notifications" id="notifications"></div>

            <div class="away-message" id="away-message">
                <h3>Welcome back!</h3>
                <p id="away-time"></p>
                <p id="water-loss"></p>
                <p id="happiness-loss"></p>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn water-btn" onclick="waterPlant()">💧 Water Plant</button>
            <button class="control-btn decorate-btn" onclick="decoratePot()">🎨 Decorate Pot</button>
            <button class="control-btn plant-select" onclick="showPlantMenu()">🌱 Change Plant</button>
        </div>

        <div class="plant-menu" id="plant-menu">
            <h3>Choose Your Plant:</h3>
            <div class="plant-options">
                <div class="plant-option" onclick="selectPlant('sunflower', '🌻')">🌻</div>
                <div class="plant-option" onclick="selectPlant('rose', '🌹')">🌹</div>
                <div class="plant-option" onclick="selectPlant('tulip', '🌷')">🌷</div>
                <div class="plant-option" onclick="selectPlant('cactus', '🌵')">🌵</div>
                <div class="plant-option" onclick="selectPlant('tree', '🌳')">🌳</div>
            </div>
            <button class="close-btn" onclick="closePlantMenu()">Close</button>
        </div>
    </div>

    <script>
        // Game state - now stores individual plant data
        let gameState = {
            currentPlant: 'sunflower',
            plants: {
                sunflower: { emoji: '🌻', waterLevel: 100, happiness: 80, colorIndex: 0, lastWatered: Date.now(), lastUpdate: Date.now() },
                rose: { emoji: '🌹', waterLevel: 100, happiness: 80, colorIndex: 0, lastWatered: Date.now(), lastUpdate: Date.now() },
                tulip: { emoji: '🌷', waterLevel: 100, happiness: 80, colorIndex: 0, lastWatered: Date.now(), lastUpdate: Date.now() },
                cactus: { emoji: '🌵', waterLevel: 100, happiness: 80, colorIndex: 0, lastWatered: Date.now(), lastUpdate: Date.now() },
                tree: { emoji: '🌳', waterLevel: 100, happiness: 80, colorIndex: 0, lastWatered: Date.now(), lastUpdate: Date.now() }
            }
        };

        const colors = ['', 'red', 'orange', 'yellow', 'green', 'blue', 'purple'];

        function getCurrentPlant() {
            return gameState.plants[gameState.currentPlant];
        }

        // Load game data on startup
        function loadGame() {
            try {
                const savedData = localStorage.getItem('plantCareGame');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    
                    // Merge saved data
                    if (parsed.currentPlant) {
                        gameState.currentPlant = parsed.currentPlant;
                    }
                    if (parsed.plants) {
                        // Merge each plant's data, keeping defaults for missing plants
                        Object.keys(parsed.plants).forEach(plantType => {
                            if (gameState.plants[plantType]) {
                                gameState.plants[plantType] = { ...gameState.plants[plantType], ...parsed.plants[plantType] };
                            }
                        });
                    }
                    
                    // Apply decay to ALL plants based on time away
                    const now = Date.now();
                    let totalWaterLost = 0;
                    let totalHappinessLost = 0;
                    let maxMinutesAway = 0;
                    
                    Object.keys(gameState.plants).forEach(plantType => {
                        const plant = gameState.plants[plantType];
                        const timeSinceLastUpdate = now - (plant.lastUpdate || now);
                        const minutesAway = timeSinceLastUpdate / (1000 * 60);
                        
                        if (minutesAway > maxMinutesAway) {
                            maxMinutesAway = minutesAway;
                        }
                        
                        if (minutesAway > 1) {
                            const waterDecay = Math.min(minutesAway * 1.5, 80);
                            const happinessDecay = Math.min(minutesAway * 1, 60);
                            
                            const oldWaterLevel = plant.waterLevel;
                            const oldHappiness = plant.happiness;
                            
                            plant.waterLevel = Math.max(0, plant.waterLevel - waterDecay);
                            plant.happiness = Math.max(0, plant.happiness - happinessDecay);
                            
                            if (plantType === gameState.currentPlant) {
                                totalWaterLost = oldWaterLevel - plant.waterLevel;
                                totalHappinessLost = oldHappiness - plant.happiness;
                            }
                        }
                        
                        plant.lastUpdate = now;
                    });
                    
                    if (maxMinutesAway > 1) {
                        showWelcomeBackMessage(maxMinutesAway, totalWaterLost, totalHappinessLost);
                    }
                }
            } catch (error) {
                console.log('Could not load game data:', error);
            }
            
            updateUI();
            saveGame();
        }

        // Save game data
        function saveGame() {
            try {
                getCurrentPlant().lastUpdate = Date.now();
                
                localStorage.setItem('plantCareGame', JSON.stringify(gameState));
                
                // Save to electron if available
                if (window.electronAPI) {
                    window.electronAPI.saveGameData(gameState);
                }
            } catch (error) {
                console.log('Could not save game data:', error);
            }
        }


        // Welcome back msg
        function showWelcomeBackMessage(minutesAway, waterLost, happinessLost) {
            const hours = Math.floor(minutesAway / 60);
            const mins = Math.floor(minutesAway % 60);
            
            let timeString = '';
            if (hours > 0) {
                timeString = `You were away for ${hours} hour${hours > 1 ? 's' : ''} and ${mins} minute${mins > 1 ? 's' : ''}.`;
            } else {
                timeString = `You were away for ${mins} minute${mins > 1 ? 's' : ''}.`;
            }
            
            showNotification(10000, `🏠 Welcome back! ${timeString}`);
            showNotification(10000, `You lost ${Math.round(waterLost/100)}% water and ${Math.round(happinessLost/100)}% happiness.`);
        }


        // Update UI elements
        function updateUI() {
            const currentPlant = getCurrentPlant();
            
            document.getElementById('water-bar').style.width = currentPlant.waterLevel + '%';
            document.getElementById('happiness-bar').style.width = currentPlant.happiness + '%';
            document.getElementById('plant-type').textContent = gameState.currentPlant.charAt(0).toUpperCase() + gameState.currentPlant.slice(1);
            document.getElementById('plant').textContent = currentPlant.emoji;
            
            const pot = document.getElementById('pot');
            const plant = document.getElementById('plant');
            
            colors.forEach(color => {
                if (color) pot.classList.remove(color);
            });

            const currentColor = colors[currentPlant.colorIndex];
            if (currentColor) {
                pot.classList.add(currentColor);
            }
            
            if (currentPlant.happiness > 60) {
                plant.classList.add('happy');
                plant.classList.remove('sad');
            } else if (currentPlant.happiness < 40) {
                plant.classList.add('sad');
                plant.classList.remove('happy');
            } else {
                plant.classList.remove('happy', 'sad');
            }
        }

        // Water the plant
        function waterPlant() {
            const currentPlant = getCurrentPlant();
            
            if (currentPlant.waterLevel < 100) {
                currentPlant.waterLevel = Math.min(100, currentPlant.waterLevel+20);
                currentPlant.happiness = Math.min(100, currentPlant.happiness+10);
                currentPlant.lastWatered = Date.now();
                
                showNotification(3000, '💧 Plant watered! Your plant is happy!');
                updateUI();
                saveGame();
            } else {
                showNotification(3000, '🌊 Plant is already well watered!');
            }
        }

        //decorate!
        function decoratePot() {
            const currentPlant = getCurrentPlant();
            
            currentPlant.colorIndex = (currentPlant.colorIndex + 1) % colors.length;
            currentPlant.happiness = Math.min(100, currentPlant.happiness + 5);
            
            const currentColor = colors[currentPlant.colorIndex];
            const colorName = currentColor || 'default brown';
            const message = `🎨 Pot is now ${colorName}!`;
            
            showNotification(3000, message);
            updateUI();
            saveGame();
        }

        function showPlantMenu() {
            document.getElementById('plant-menu').classList.add('active');
        }

        function closePlantMenu() {
            document.getElementById('plant-menu').classList.remove('active');
        }

        // Select a new plant
        function selectPlant(type, emoji) {
            saveGame();
            gameState.currentPlant = type;
            
            const newPlant = getCurrentPlant();
            newPlant.happiness = Math.min(100, newPlant.happiness + 5);
            
            showNotification(3000, `🌱 Switched to your ${type}! ${emoji}`);
            updateUI();
            saveGame();
            closePlantMenu();
        }

        // Show notification
        function showNotification(time, message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, time);
        }

        // Game loop - decrease water and happiness over time while playing
        function gameLoop() {
            // Update timestamp
            gameState.lastUpdate = Date.now();
            
            gameState.waterLevel = Math.max(0, gameState.waterLevel - 2);
            
            gameState.happiness = Math.max(0, gameState.happiness - 1);
            
            // Extra happiness decrease if water is very low
            if (gameState.waterLevel < 20) {
                gameState.happiness = Math.max(0, gameState.happiness - 2);
            }
            
            if (gameState.waterLevel <= 10) {
                showNotification(3000, '🚨 Your plant is very thirsty!');
            } else if (gameState.waterLevel <= 30) {
                showNotification(3000, '💧 Your plant needs water soon!');
            }
            
            if (gameState.happiness <= 10) {
                showNotification(3000, '😢 Your plant is very sad!');
            } else if (gameState.happiness <= 30) {
                showNotification(3000,'😐 Your plant needs attention!');
            }
            
            updateUI();
            saveGame();
        }

        // Save game state when page is about to unload
        window.addEventListener('beforeunload', function() {
            saveGame();
        });

        // Save periodically in case of unexpected closure
        setInterval(saveGame, 30000); // Save every 30 seconds

        // Initialize game
        loadGame();
        setInterval(gameLoop, 60000); // Run every 60 seconds (1 minute)
    </script>
</body>
</html>